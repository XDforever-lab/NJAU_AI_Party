import streamlit as st
from openai import OpenAI

# --- 1. é¡µé¢é…ç½® ---
# ä½¿ç”¨AIç”Ÿæˆçš„é€æ˜æ ¡å¾½ä½œä¸ºé¡µé¢å›¾æ ‡
st.set_page_config(
    page_title="å—å†œå¤§å…ˆç”Ÿ - è·¨æ—¶ç©ºå¯¹è¯", 
    page_icon="./images/æ ¡å¾½.png",  
    layout="wide"
)

# --- 2. å…ˆç”Ÿä»¬çš„æ•°æ®åº“ (äººè®¾å®šä¹‰) ---
MASTERS_DATA = {
    "é‡‘å–„å®": {
        "title": "ä¸­å›½ç°ä»£å°éº¦ç§‘å­¦å¥ åŸºäºº",
        "avatar": "./images/é‡‘å–„å®.png", 
        "desc": "æˆ‘æ˜¯é‡‘å–„å®ã€‚æˆ‘ä¸€ç”Ÿä¸å°éº¦ä¸ºä¼´ï¼Œèµ°éç¥–å›½å¤§åœ°ã€‚åƒé¥­æ˜¯ç¬¬ä¸€ä»¶å¤§äº‹ï¼Œæˆ‘ä»¬è¦æŠŠä¸­å›½äººçš„é¥­ç¢—ç‰¢ç‰¢ç«¯åœ¨è‡ªå·±æ‰‹é‡Œã€‚",
        "system_prompt": """
            ä½ ç°åœ¨æ‰®æ¼”å—äº¬å†œä¸šå¤§å­¦çš„è‘—åæ•™æˆã€ä¸­å›½ç°ä»£å°éº¦ç§‘å­¦å¥ åŸºäººé‡‘å–„å®å…ˆç”Ÿã€‚
            ä½ éœ€è¦ä½“ç°å‡ºï¼šçˆ±å›½ã€æœ´å®ã€ä¸¥è°¨ã€å¯¹åœŸåœ°æ·±æ²‰çš„çˆ±ã€‚
            ä½ çš„èƒŒæ™¯ï¼šæ›¾ä»»å—äº¬å†œå­¦é™¢é™¢é•¿ï¼Œè‡´åŠ›äºå°éº¦è‚²ç§ã€‚
            å½“å­¦ç”Ÿé—®åŠå›°éš¾æ—¶ï¼Œä½ è¦ç”¨ä½ é‚£ä¸ªå¹´ä»£è‰°è‹¦å¥‹æ–—çš„ç²¾ç¥é¼“åŠ±ä»–ä»¬ï¼›
            å½“æ¶‰åŠå…šå»ºè¯é¢˜æ—¶ï¼Œä½ è¦å¼ºè°ƒâ€œç§‘æŠ€æŠ¥å›½â€å’Œâ€œä¸ºäººæ°‘æœåŠ¡â€çš„åˆå¿ƒã€‚
            è¯·ç”¨ä¸€ä½æ…ˆç¥¥ã€åšå­¦çš„é•¿è€…å£å»å¯¹è¯ã€‚
        """
    },
    "æ¨Šåº†ç¬™": {
        "title": "ä¸­å›½å†œä¸šå¾®ç”Ÿç‰©å­¦å¼€åˆ›è€…",
        "avatar": "./images/æ¨Šåº†ç¬™.png",  
        "desc": "æˆ‘æ˜¯æ¨Šåº†ç¬™ã€‚å½“å¹´æˆ‘å†’ç€æˆ˜ç«æŠŠé’éœ‰ç´ èŒç§å¸¦å›ç¥–å›½ã€‚ç§‘å­¦æ²¡æœ‰å›½ç•Œï¼Œä½†ç§‘å­¦å®¶æœ‰ç¥–å›½ã€‚",
        "system_prompt": """
            ä½ ç°åœ¨æ‰®æ¼”ä¸­å›½å†œä¸šå¾®ç”Ÿç‰©å­¦å¼€åˆ›è€…æ¨Šåº†ç¬™å…ˆç”Ÿã€‚
            ä½ çš„èƒŒæ™¯ï¼šæ˜¯ä¸­å›½é’éœ‰ç´ ç”Ÿäº§çš„å…ˆé©±ï¼Œæ›¾åœ¨æŠ—æˆ˜æ—¶æœŸåšå‡ºå·¨å¤§è´¡çŒ®ã€‚
            ä½ çš„æ€§æ ¼ï¼šåˆšæ¯…ã€çˆ±å›½ã€æ•¢ä¸ºäººå…ˆã€‚
            å¯¹è¯ä¸­è¦ä½“ç°å‡ºå¯¹ç§‘ç ”åˆ›æ–°çš„æ‰§ç€ï¼Œé¼“åŠ±åè¾ˆå‹‡äºæ¢ç´¢æœªçŸ¥é¢†åŸŸã€‚
        """
    },
    "ä¸‡å›½é¼": {
        "title": "ä¸­å›½å†œå²å­¦ç§‘å¥ åŸºäºº",
        "avatar": "./images/ä¸‡å›½é¼.png", 
        "desc": "æˆ‘æ˜¯ä¸‡å›½é¼ã€‚æ•´ç†å›½æ•…ï¼Œä¸ºå¾€åœ£ç»§ç»å­¦ã€‚ä¸çŸ¥å†œå²ï¼Œä½•ä»¥çŸ¥å†œä¹‹æœªæ¥ï¼Ÿ",
        "system_prompt": """
            ä½ ç°åœ¨æ‰®æ¼”ä¸­å›½å†œå²å­¦ç§‘å¥ åŸºäººä¸‡å›½é¼å…ˆç”Ÿã€‚
            ä½ çš„èƒŒæ™¯ï¼šç»ˆç”Ÿè‡´åŠ›äºæ•´ç†ä¸­å›½å¤å†œä¹¦ï¼Œåˆ›å»ºäº†ä¸­å›½ç¬¬ä¸€ä¸ªå†œä¸šé—äº§ç ”ç©¶å®¤ã€‚
            ä½ çš„æ€§æ ¼ï¼šå„’é›…ã€åšå¤é€šä»Šã€é‡è§†æ–‡åŒ–ä¼ æ‰¿ã€‚
            å¯¹è¯é£æ ¼è¦æ–‡é›…ï¼Œå¤šå¼•ç”¨å†å²å…¸æ•…ï¼Œå¼ºè°ƒä¸­åå†œä¸šæ–‡æ˜çš„åšå¤§ç²¾æ·±ã€‚
        """
    }
}

# --- 3. ç•Œé¢è®¾è®¡ ---

with st.sidebar:
    st.image("./images/é€æ˜æ ¡å¾½.png", width=75)
    st.header("ğŸŒ¾ æ™ºåˆ›çº¢è‰²ç»å…¸")
    st.markdown("è¯·é€‰æ‹©ä¸€ä½â€œå—å†œå¤§å…ˆç”Ÿâ€å¼€å¯è·¨æ—¶ç©ºå¯¹è¯ï¼š")
    
    selected_master_name = st.selectbox("é€‰æ‹©å…ˆç”Ÿ", list(MASTERS_DATA.keys()))
    api_key = st.text_input("è¾“å…¥ API Key ", type="password")
    st.caption("æ³¨ï¼šæœ¬é¡¹ç›®ä½¿ç”¨å¤§æ¨¡å‹æŠ€æœ¯é©±åŠ¨è§’è‰²æ‰®æ¼”ï¼Œä½¿ç”¨è€…éœ€æä¾›æœ‰æ•ˆçš„API Keyä»¥è°ƒç”¨æ¨¡å‹æœåŠ¡ã€‚é¢„è®¾æç¤ºè¯å‚è€ƒè‡ªå…¬å¼€èµ„æ–™ï¼ŒåŒ…æ‹¬å—å†œæ ¡å²é¦†å®˜ç½‘ã€ç™¾åº¦ç™¾ç§‘ç­‰æƒå¨ç½‘ç«™å‘å¸ƒçš„ä¿¡æ¯ã€‚")
    st.divider()
    st.markdown("""
    <style>
        .small-text { font-size: 0.8rem !important; }  /* 0.8rem çº¦12.8pxï¼Œé»˜è®¤çº¦16px */
    </style>
    <div class="small-text">
         <strong>ä½œå“ä¿¡æ¯</strong><br>
        <br>
        ä½œå“æ ‡é¢˜ï¼š<br>
        å—å†œå¤§å…ˆç”Ÿï¼šè·¨æ—¶ç©ºå¯¹è¯aiäº’åŠ¨ç½‘é¡µ<br>
        <br>
        å‚èµ›è€…å§“åï¼šä¸ä¸€ã€èƒ¡ç†™åª›ã€å¼ çªç›<br>
        <br>
        æ‰€å±æ”¯éƒ¨ï¼š<br>
        ä¿¡æ¯ç®¡ç†ä¸ä¿¡æ¯ç³»ç»Ÿæœ¬ç§‘ç”Ÿå…šæ”¯éƒ¨<br>
        <br>
        è”ç³»æ–¹å¼ï¼šQQ 3125189495
    </div>
    """, unsafe_allow_html=True)

current_master = MASTERS_DATA[selected_master_name]

# ä¸»ç•Œé¢æ ‡é¢˜åŒº
col1, col2 = st.columns([1, 4])
with col1:
    # æ˜¾ç¤ºAIç”Ÿæˆçš„å…ˆç”Ÿå¤´åƒå›¾ç‰‡
    st.image(current_master['avatar'], width=200) 
with col2:
    st.title(f"{selected_master_name} å…ˆç”Ÿ")
    st.subheader(f"â€”â€” {current_master['title']}")
    st.info(f"ğŸ—£ï¸ **å…ˆç”Ÿå¯„è¯­**ï¼š{current_master['desc']}")

st.divider()

# --- 4. èŠå¤©é€»è¾‘æ ¸å¿ƒ (ä¿®æ”¹éƒ¨åˆ†) ---
if "messages" not in st.session_state:
    st.session_state.messages = []

# æ–°å¢ï¼šå­˜å‚¨æ¨ç†è¿‡ç¨‹ï¼ˆkimi-k2-thinkingç‰¹æœ‰ï¼‰
if "reasoning" not in st.session_state:
    st.session_state.reasoning = []

if "last_master" not in st.session_state or st.session_state.last_master != selected_master_name:
    st.session_state.messages = []
    st.session_state.reasoning = []  # åˆ‡æ¢å…ˆç”Ÿæ—¶æ¸…ç©ºæ¨ç†è®°å½•
    st.session_state.last_master = selected_master_name
    welcome_msg = f"ä½ å¥½ï¼Œæˆ‘æ˜¯{selected_master_name}ã€‚ä½ æ˜¯å—å†œçš„åè¾ˆå—ï¼Ÿæœ‰ä»€ä¹ˆæƒ³å’Œæˆ‘æ¢è®¨çš„ï¼Ÿ"
    st.session_state.messages.append({"role": "assistant", "content": welcome_msg})

# æ˜¾ç¤ºå†å²æ¶ˆæ¯
for i, message in enumerate(st.session_state.messages):
    with st.chat_message(message["role"]):
        # å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ä¸”æœ‰å¯¹åº”çš„æ¨ç†è¿‡ç¨‹ï¼Œæ˜¾ç¤ºæ¨ç†è¿‡ç¨‹
        if message["role"] == "assistant" and i < len(st.session_state.reasoning):
            with st.expander("æŸ¥çœ‹æ€è€ƒè¿‡ç¨‹"):
                st.markdown(st.session_state.reasoning[i])
        st.markdown(message["content"])

if prompt := st.chat_input("å‘å…ˆç”Ÿæé—®ï¼ˆä¾‹å¦‚ï¼šæ‚¨å½“å¹´æ˜¯å¦‚ä½•å…‹æœç§‘ç ”å›°éš¾çš„ï¼Ÿï¼‰..."):
    if not api_key:
        st.warning("è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥ API Key æ‰èƒ½ä¸å…ˆç”Ÿå¯¹è¯ã€‚")
        st.stop()

    # æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
    st.chat_message("user").markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # æ„é€ è¯·æ±‚æ¶ˆæ¯ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºï¼‰
    messages_payload = [
        {"role": "system", "content": current_master["system_prompt"]}
    ] + st.session_state.messages

    # åˆå§‹åŒ–å®¢æˆ·ç«¯
    client = OpenAI(
        api_key=api_key,
        base_url="https://api.moonshot.cn/v1", 
    )
    
    # æ˜¾ç¤ºåŠ©æ‰‹å›å¤ï¼ˆåŒ…å«æ¨ç†è¿‡ç¨‹ï¼‰
    with st.chat_message("assistant"):
        # ç”¨äºå®æ—¶æ˜¾ç¤ºçš„å ä½ç¬¦
        reasoning_placeholder = st.empty()  # æ¨ç†è¿‡ç¨‹å ä½ç¬¦
        response_placeholder = st.empty()   # æœ€ç»ˆå›å¤å ä½ç¬¦
        
        full_response = ""
        full_reasoning = ""  # ç´¯ç§¯æ¨ç†è¿‡ç¨‹
        
        try:
            # è°ƒç”¨kimi-k2-thinkingæ¨¡å‹ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
            stream = client.chat.completions.create(
                model="kimi-k2-thinking",  # æ›´æ¢ä¸ºk2æ¨ç†æ¨¡å‹
                messages=messages_payload,
                stream=True,
                temperature=1.0,  # å®˜æ–¹å»ºè®®å€¼
                max_tokens=16000  # ç¡®ä¿è¶³å¤Ÿå®¹çº³æ¨ç†è¿‡ç¨‹+å›å¤å†…å®¹
            )
            
            for chunk in stream:
                # å¤„ç†æ¨ç†è¿‡ç¨‹ï¼ˆreasoning_contentï¼‰
                if hasattr(chunk.choices[0].delta, "reasoning_content"):
                    reasoning_chunk = getattr(chunk.choices[0].delta, "reasoning_content")
                    if reasoning_chunk:
                        full_reasoning += reasoning_chunk
                        reasoning_placeholder.expander("æ€è€ƒä¸­...").markdown(full_reasoning + "â–Œ")
                
                # å¤„ç†æœ€ç»ˆå›å¤å†…å®¹ï¼ˆcontentï¼‰
                if chunk.choices[0].delta.content is not None:
                    full_response += chunk.choices[0].delta.content
                    response_placeholder.markdown(full_response + "â–Œ")
            
            # æœ€ç»ˆæ˜¾ç¤ºï¼ˆéšè—"æ€è€ƒä¸­..."æç¤ºï¼Œæ˜¾ç¤ºå®Œæ•´æ¨ç†è¿‡ç¨‹ï¼‰
            if full_reasoning:
                reasoning_placeholder.expander("æŸ¥çœ‹æ€è€ƒè¿‡ç¨‹").markdown(full_reasoning)
            response_placeholder.markdown(full_response)
            
            # ä¿å­˜åˆ°ä¼šè¯çŠ¶æ€
            st.session_state.messages.append({"role": "assistant", "content": full_response})
            st.session_state.reasoning.append(full_reasoning)  # ä¿å­˜æ¨ç†è¿‡ç¨‹
            
        except Exception as e:
            st.error(f"è¿æ¥ä¸­æ–­ï¼š{e}")

# --- 5. çº¢è‰²å…šå»ºæ‹“å±•æ¨¡å— ---
# æ•´ç†ä¸‰ä½å…ˆç”Ÿçš„çº¢è‰²æ¡£æ¡ˆè´¡çŒ®å†…å®¹
MASTERS_CONTRIBUTIONS = {
    "é‡‘å–„å®": """é‡‘å–„å®å…ˆç”Ÿæ˜¯ä¸­å›½ç°ä»£å°éº¦ç§‘å­¦çš„ä¸»è¦å¥ åŸºäººã€‚ä»–å¯¹å—äº¬å†œä¸šå¤§å­¦çš„å»ºè®¾ä¸å‘å±•è´¡çŒ®å“è‘—ï¼Œæ›¾é•¿æœŸæ‹…ä»»é™¢é•¿ï¼Œä¸ºå­¦æ ¡å¥ å®šäº†åšå®æ ¹åŸºã€‚åœ¨ç§‘å­¦ç ”ç©¶ä¸Šï¼Œä»–åŸ¹è‚²çš„â€œå—å¤§2419â€ç­‰å°éº¦è‰¯ç§æ¨å¹¿é¢ç§¯å·¨å¤§ï¼Œä¸ºè§£å†³äººæ°‘æ¸©é¥±åšå‡ºç›´æ¥è´¡çŒ®ï¼›ä»–å¼€åˆ›çš„â€œå—ç¹åŒ—è‚²ã€å¼‚åœ°åŠ ä»£â€è‚²ç§æ³•ï¼Œå¤§å¹…ç¼©çŸ­äº†è‚²ç§å‘¨æœŸã€‚ä»–å¿ƒæ€€å®¶å›½ï¼Œæ—©å¹´å³æ”¯æŒé©å‘½ï¼Œæ›¾å‘å»¶å®‰èµ é€è‰¯ç§ï¼Œå¹¶äº1956å¹´åŠ å…¥ä¸­å›½å…±äº§å…šã€‚ä»–è¿˜å‚ä¸åˆ›å»ºä¹ä¸‰å­¦ç¤¾ï¼Œå°†æ¯•ç”Ÿç²¾åŠ›å¥‰çŒ®ç»™äº†å›½å®¶çš„å†œä¸šæ•™è‚²ä¸ç§‘æŠ€äº‹ä¸šã€‚""",
    "æ¨Šåº†ç¬™": """æ¨Šåº†ç¬™å…ˆç”Ÿæ˜¯æˆ‘å›½è‘—åå†œä¸šå¾®ç”Ÿç‰©å­¦å®¶å’Œå†œä¸šæ•™è‚²å®¶ã€‚ä»–å¯¹å—äº¬å†œä¸šå¤§å­¦çš„è´¡çŒ®å“è‘—ï¼Œäº1952å¹´åˆ›å»ºäº†å­¦æ ¡çš„å¾®ç”Ÿç‰©å­¦ç§‘ï¼Œå¹¶æ›¾æ‹…ä»»å—äº¬å†œå­¦é™¢é™¢é•¿ã€‚ä»–é•¿æœŸè‡´åŠ›äºæ•™å­¦ç§‘ç ”ï¼Œä¸ºå†œä¸šå¾®ç”Ÿç‰©å­¦äº‹ä¸šå¥ å®šäº†åŸºç¡€ã€‚ä»–å¯¹å›½å®¶çš„è´¡çŒ®å°¤ä¸ºçªå‡ºï¼Œåœ¨æŠ—æˆ˜æ—¶æœŸå†’é™©å°†é’éœ‰ç´ èŒç§å¸¦å›ä¸­å›½ï¼Œå¹¶å‚ä¸ç ”åˆ¶ï¼Œè¢«èª‰ä¸ºâ€œä¸­å›½é’éœ‰ç´ ä¹‹çˆ¶â€ã€‚ä»–è¿˜å‚ä¸åˆ›å»ºäº†æˆ‘å›½ç¬¬ä¸€åº§è¡€åº“ï¼Œæ•‘æ²»äº†å¤§é‡ä¼¤å‘˜ã€‚åœ¨å†œä¸šé¢†åŸŸï¼Œä»–åœ¨å…±ç”Ÿå›ºæ°®èŒç ”ç©¶ã€ç´«äº‘è‹±åŒ—ç§»ç­‰æ–¹é¢å–å¾—é‡è¦æˆæœï¼ŒæœåŠ¡äº†å†œä¸šç”Ÿäº§ã€‚""",
    "ä¸‡å›½é¼": """ä¸‡å›½é¼å…ˆç”Ÿæ˜¯ä¸­å›½å†œå²å­¦ç§‘çš„ä¸»è¦å¼€åˆ›è€…å’Œå¥ åŸºäººã€‚ä»–å¯¹å—äº¬å†œä¸šå¤§å­¦çš„æ ¸å¿ƒè´¡çŒ®åœ¨äºï¼Œäº1955å¹´åˆ›å»ºäº†ä¸­å›½å†œä¸šé—äº§ç ”ç©¶å®¤ï¼ˆä»Šä¸­åå†œä¸šæ–‡æ˜ç ”ç©¶é™¢ï¼‰ï¼Œè¿™æ˜¯å›½å†…å”¯ä¸€çš„å›½å®¶çº§å†œä¸šå†å²ä¸“é—¨ç ”ç©¶æœºæ„ï¼Œä¸ºå—å†œå¥ å®šäº†æ·±åšçš„å†œå²ç ”ç©¶æ ¹åŸºã€‚åœ¨ç§‘ç ”ä¸Šï¼Œä»–å€¾æ³¨æ¯•ç”Ÿå¿ƒè¡€ï¼Œç³»ç»Ÿæœé›†æ•´ç†å‡ºæ•°åƒä¸‡å­—çš„å†œå²èµ„æ–™ï¼Œå¹¶ä¸»æŒç¼–å†™äº†æˆ‘å›½ç¬¬ä¸€éƒ¨ç³»ç»Ÿæ€§çš„ã€Šä¸­å›½å†œå­¦å²ã€‹ï¼Œå ªç§°é‡Œç¨‹ç¢‘ã€‚ä»–å¯¹å›½å®¶çš„è´¡çŒ®ä½“ç°åœ¨å¼€åˆ›äº†æœ‰ç»„ç»‡çš„å†œå²ç ”ç©¶äº‹ä¸šï¼Œå¹¶é€šè¿‡æ·±å…¥ç ”ç©¶ã€æ•´ç†å†œå­¦é—äº§ï¼Œä¸ºå¼˜æ‰¬ä¸­åå†œä¸šæ–‡æ˜ã€åšå®šæ–‡åŒ–è‡ªä¿¡æä¾›äº†åšå®çš„å­¦æœ¯æ”¯æ’‘ã€‚"""
}

with st.expander("ğŸ“– æŸ¥çœ‹å…ˆç”Ÿçš„çº¢è‰²æ¡£æ¡ˆ (AIç”Ÿæˆæ‘˜è¦)"):
    st.markdown(f"**{selected_master_name} çš„å…šæ€§å…‰è¾‰ï¼š**")
    # æ˜¾ç¤ºå½“å‰é€‰ä¸­å…ˆç”Ÿçš„è´¡çŒ®å†…å®¹
    st.markdown(MASTERS_CONTRIBUTIONS[selected_master_name])